#!/bin/bash

set -euo pipefail

source $1
subnets=$(echo -n "${subnets}" | sed "s/,/ /g")

sg=$(aws ec2 describe-security-groups --group-names ${sg_name} | jq -r '.SecurityGroups[].GroupId')
elb=$(aws elbv2 create-load-balancer --name ${name} --subnets ${subnets} --security-groups ${sg})
elb_arn=$(echo -n ${elb} | jq -r '.LoadBalancers[].LoadBalancerArn')

target_group_arn=$(aws elbv2 create-target-group --name ${target_name} --protocol HTTP --port 80 --vpc-id ${vpc_id} --health-check-path ${healthcheck_path} --matcher HttpCode=${healthcheck_http_code} | jq -r '.TargetGroups[].TargetGroupArn')

res=$(aws elbv2 create-listener --load-balancer-arn ${elb_arn} --protocol HTTPS --port 443 --certificates CertificateArn=${certificate_arn} --ssl-policy ELBSecurityPolicy-2015-05 --default-actions Type=forward,TargetGroupArn=${target_group_arn})

echo -n ${elb} | jq ".LoadBalancers[] + {changed: true}"

exit 0
