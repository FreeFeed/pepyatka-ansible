---

- hosts: all
  vars:
    pepyatka_deploy_log_dir: /var/log/pepyatka-deploy
  roles:
    - security
  tasks:
    - name: Install apt-transport-https
      apt: name=apt-transport-https state=present force=yes
      tags:
        - bootstrap

    - name: Install required packages
      apt: name={{ item }} state=present update_cache=yes force=yes
      with_items:
        - python-pip
        - python-dev
        - git
        - sudo
      tags:
        - bootstrap

    - name: Install required python modules
      pip: name={{ item }} state=latest
      with_items:
        - dogapi
        - httplib2
        - ansible
      tags:
        - bootstrap

    - name: Clone pepyatka-ansible
      git:
        repo: "{{ pepyatka_ansible_repo }}"
        dest: /root/pepyatka-ansible
        version: "{{ pepyatka_ansible_branch }}"
        force: yes
      tags:
        - bootstrap

    - name: Clone pepyatka-server
      git:
        repo: "{{ pepyatka_server_repo }}"
        dest: /root/pepyatka-server
        version: "{{ pepyatka_server_branch }}"
        force: yes
      tags:
        - bootstrap

    - name: Clone pepyatka-html
      git:
        repo: "{{ pepyatka_html_repo }}"
        dest: /root/pepyatka-html
        version: "{{ pepyatka_html_branch }}"
        force: yes
      when: pepyatka_html_enabled
      tags:
        - bootstrap

    - name: Clone pepyatka-lite
      git:
        repo: "{{ pepyatka_lite_repo }}"
        dest: /root/pepyatka-lite
        version: "{{ pepyatka_lite_branch }}"
      when: pepyatka_lite_enabled
      tags:
        - bootstrap

    - name: Clone freefeed-react-client
      git:
        repo: "{{ freefeed_react_client_repo }}"
        dest: /root/freefeed-react-client
        version: "{{ freefeed_react_client_branch }}"
      when: freefeed_react_client_enabled
      tags:
        - bootstrap

    - name: Copy vault password file
      copy: src={{ vault_password_file }} dest=/root/pepyatka.vault
      when: vault_password_file is defined
      tags:
        - bootstrap

    - name: Deploy check-deploy script
      template: src=check-deploy.j2 dest=/root/check-deploy mode=0700
      tags:
        - bootstrap
        - check-deploy

    - name: Deploy inventory for check-deploy script
      copy: src=../{{ pepyatka_deploy_inventory }} dest=/root/pepyatka-ansible/{{ pepyatka_deploy_inventory }}
      tags:
        - bootstrap

    - name: Create directory for check-deploy logs
      file: path={{ pepyatka_deploy_log_dir }} state=directory
      tags:
        - bootstrap

    - name: Setup logrotate for check-deploy logs
      template: src=check-deploy.logrotate.j2 dest=/etc/logrotate.d/check-deploy
      tags:
        - bootstrap

    - name: Force first time deploy
      command: /root/check-deploy --force
      tags:
        - bootstrap

    - name: Setup cron job for check-deploy
      cron:
        name="Deploy pepyatka"
        cron_file=check-deploy
        job=/root/check-deploy
        user=root
        minute="*/5"
        state=present
      tags:
        - bootstrap

