---

- name: Install nginx
  become: yes
  ansible.builtin.package:
    name: nginx
    state: present

- name: Ensure /etc/nginx/conf.d
  become: yes
  ansible.builtin.file:
    path: /etc/nginx/conf.d
    state: directory
  tags:
    - config

- name: Start imgproxy container
  become: yes
  when: use_imgproxy
  community.docker.docker_container:
    name: "imgproxy-{{ freefeed_env }}"
    image: "darthsim/imgproxy:v3"
    state: started
    restart_policy: on-failure
    ports:
      - "{{ imgproxy_port }}:8080"
    env:
      IMGPROXY_ONLY_PRESETS: 'true'
      IMGPROXY_PRESETS: 'thumbnails=s:525:175/sh:0.5,thumbnails2=s:1050:350/sh:0.3,2k=s:2000:2000,profile50=s:100:100/rt:fill,profile75=s:150:150/rt:fill'
      IMGPROXY_USE_ETAG: 'true'
      IMGPROXY_MAX_SRC_RESOLUTION: '50'
      IMGPROXY_JPEG_PROGRESSIVE: 'true'
      IMGPROXY_PNG_INTERLACED: 'true'
      IMGPROXY_MAX_ANIMATION_FRAMES: '100'
      IMGPROXY_DATADOG_ENABLE: 'true'
      DD_AGENT_HOST: '172.18.0.1'
      DD_ENV: "{{ freefeed_env }}"
    healthcheck:
      test: [ "CMD", "imgproxy", "health" ]
      timeout: 10s
      interval: 10s
      retries: 3

- name: Render ssl.conf
  become: yes
  ansible.builtin.template:
    src: ssl.conf.j2
    dest: /etc/nginx/ssl.conf
  tags:
    - config
  notify: Reload nginx

- name: Render nginx.conf
  become: yes
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  tags:
    - config
  notify: Reload nginx

- name: Render /etc/nginx/conf.d/{{ freefeed_hostname }}.conf
  become: yes
  ansible.builtin.template:
    src: site.conf.j2
    dest: "/etc/nginx/conf.d/{{ freefeed_hostname }}.conf"
  tags:
    - config
  notify: Reload nginx

- name: Render /etc/nginx/conf.d/{{ freefeed_media_hostname }}.conf
  become: yes
  ansible.builtin.template:
    src: media.conf.j2
    dest: "/etc/nginx/conf.d/{{ freefeed_media_hostname }}.conf"
  tags:
    - config
  notify: Reload nginx
