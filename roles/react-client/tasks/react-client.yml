---

- name: Ensure git is installed
  apt: name=git state=present

- name: Deploy react-client
  git:
    repo: "{{ react_client_repo }}"
    update: yes
    dest: "{{ react_client_dir }}"
    version: "{{ react_client_branch }}"
    force: yes
  register: react_client

- name: Save changelog in a file
  shell: echo "{{ react_client.before }}...{{ react_client.after }}" > /tmp/react-client-changelog
  when: react_client.before != react_client.after

- name: Fetch react-client changelog
  fetch:
    src=/tmp/react-client-changelog
    dest="react-client-changelog/{{ inventory_hostname }}"
    flat=yes
  when: react_client.before != react_client.after

- name: Kill local node_modules
  file: path="{{ react_client_dir }}/node_modules" state=absent
  when: react_client.before != react_client.after

- name: Install fresh YARN
  command: npm install -g yarn

- name: Install dependencies
  command: yarn install
  args:
    chdir: "{{ react_client_dir }}"

- name: Build assets
  command: yarn build-prod
  args:
    chdir: "{{ react_client_dir }}"
  environment:
    FRF_API_ROOT: "{{ pepyatka_frontend_scheme }}://{{ react_client_hostname }}"
    FRF_SITE_ORIGIN: "{{ pepyatka_frontend_scheme }}://{{ react_client_hostname }}"
    FRF_TOKEN_PREFIX: "{{ auth_token_prefix }}"
    FRF_USER_STORAGE_KEY: "{{ local_storage_whoami_cache_key }}"
    FRF_CAPTCHA_SITEKEY: "{{ recaptcha_client_secret }}"
    FRF_SENTRY_DSN: "{{ public_sentry_dsn }}"

- name: Fix permissions
  file:
    path: "{{ react_client_dir }}"
    owner: "{{ www_user }}"
    group: "{{ www_group }}"
    state: directory
    recurse: yes

